#+STARTUP: overview
* User Details
#+begin_src emacs-lisp
;;; config.el -*- lexical-binding: t; -*-
;; Some functionality uses this to identify you, e.g. GPG configuration, email
;; clients, file templates and snippets
(setq user-full-name "Eugene Rwagasore"
      user-mail-address "mail@rwagasore.com")
#+end_src

* Sane Defaults
#+begin_src emacs-lisp
(setq-default
 delete-by-moving-to-trash t
 window-combination-resize t)

(setq mac-mouse-wheel-smooth-scroll t)

;; Increase amount of data read from process (4MB for better streaming with AI tools)
(setq read-process-output-max (* 4 1024 1024)) ;; 4mb

;; Remove gaps between your emacs frames and other windows
(setq frame-resize-pixelwise t)

;; Allow internal emacs to use posix shell and vterm to user fish
(setq shell-file-name (executable-find "bash"))
;; More robust shell detection
(setq-default vterm-shell (or (executable-find "fish") 
                              "/bin/bash"))
(setq-default explicit-shell-file-name (or (executable-find "fish")
                                           "/bin/bash"))

;; Set Scratch to org-mode as default
(setq initial-major-mode 'org-mode)

;; autosave - optimized intervals for better performance
(auto-save-visited-mode t)
(setq auto-save-timeout 20)  ; 20 seconds instead of 1
(setq auto-save-interval 200) ; 200 keystrokes instead of 50
(setq default-directory "~")

;; Improve the modeline and Icons
(setq nerd-icons-scale-factor 1)
(setq doom-modeline-height 32)

;; Remap the keybinding to open xwidget browser
(map! :leader
      :desc "Open XWidget Browser URL" "o b" #'xwidget-webkit-browse-url)

(setq ns-use-srgb-colorspace nil)

(defun my/auth-get (host)
  "Get password for HOST from .authinfo.gpg"
  (when-let* ((result (car (auth-source-search :host host :max 1)))
              (secret (plist-get result :secret)))
    (funcall secret)))

;; Suppress warnings in minibuffer
(setq warning-minimum-level :error)

;; Handle files with very long lines gracefully
(global-so-long-mode 1)
#+end_src

#+begin_src emacs-lisp
;; Disable undo-tree persistent history
(after! undo-tree
  (setq undo-tree-auto-save-history nil))
#+end_src

* Font Rendering
#+begin_src emacs-lisp
(setq doom-font (font-spec :family "Pragmasevka Nerd Font" :style "Regular" :size 15)
      doom-big-font (font-spec :family "Pragmasevka Nerd Font" :style "Regular" :size 18)
      doom-variable-pitch-font (font-spec :family "Pragmasevka Nerd Font" :style "Regular" :size 15)
      doom-unicode-font (font-spec :family "Apple Color Emoji")
      default-text-properties '(line-spacing 0 line-height 1 style "Retina"))
#+end_src
* Theme Configurations
#+begin_src emacs-lisp
;; Use ns-system-appearance on macOS for automatic theme switching
;; heaven-and-hell is kept only for manual toggle via C-c t T
(defun my/apply-theme (appearance)
  "Load theme, taking current system APPEARANCE into consideration."
  (mapc #'disable-theme custom-enabled-themes)
  (pcase appearance
    ('light (load-theme 'era t))
    ('dark (load-theme 'ijima t))))

;; Setup system appearance handling with proper guards
(when (featurep 'ns) ; Only on macOS
  (add-hook 'ns-system-appearance-change-functions #'my/apply-theme)
  (when (boundp 'ns-system-appearance)
    (my/apply-theme ns-system-appearance)))

;; Manual theme toggle (doesn't interfere with system appearance)
(after! heaven-and-hell
  (setq heaven-and-hell-themes
        '((light . era)
          (dark . ijima)))
  (setq heaven-and-hell-load-theme-no-confirm t)
  (map! :g "C-c t T" 'heaven-and-hell-toggle-theme))

;; Don't use heaven-and-hell init hook - let ns-system-appearance handle initial theme
;; (add-hook 'after-init-hook 'heaven-and-hell-init-hook)

(after! doom-themes
  (doom-themes-org-config)
  (doom-themes-visual-bell-config)
  (setq doom-themes-enable-bold t
        doom-themes-enable-italic t))
#+end_src

* UI Configurations
#+begin_src emacs-lisp
;; Disable Emacs killing confirmation
(setq confirm-kill-emacs nil)

;; Cleaner frame setup - consolidate all frame settings
(setq default-frame-alist
      '((width . 145)
        (height . 43)
        (left . 0.5)
        (top . 0.5)
        (alpha . (100 . 96))
        (undecorated-round . t)))
;; Apply same settings to initial frame
(setq initial-frame-alist default-frame-alist)
;; No need for separate set-frame-parameter call - it's in default-frame-alist

;; Customize the cursor
(setq-default
 cursor-type '(bar . 1)
 blink-cursor-delay 0
 blink-cursor-interval 0.4)

;; Default fringe size for all frames
(fringe-mode '(3 . 3))
(setq-default indicate-empty-lines t)

(blink-cursor-mode t)

;; Disable fringe-mode on xwidget
(defun no-fringes-config ()
  "Used in `window-configuration-change-hook' to configure fringes"
  (set-window-fringes nil 0 0))

(defun xwidget-webkit-no-fringes-hook ()
  "Custom `xwidget-webkit-mode' behaviours."
  (setq header-line-format nil)
  (add-hook 'window-configuration-change-hook
            'no-fringes-config nil :local))

(add-hook 'xwidget-webkit-mode-hook 'xwidget-webkit-no-fringes-hook)

;; Use relative line numbers only in prog-mode and text-mode
(setq display-line-numbers-type 'relative)
(add-hook 'prog-mode-hook #'display-line-numbers-mode)
(add-hook 'text-mode-hook #'display-line-numbers-mode)
(add-hook 'conf-mode-hook #'display-line-numbers-mode)


;; Customise modeline
(setq doom-modeline-modal-icon nil
      doom-modeline-modal-modern-icon nil)

;; remove abbreviation
(after! evil
  (setq evil-normal-state-tag   "NORMAL"
        evil-insert-state-tag   "INSERT"
        evil-visual-state-tag   "VISUAL"
        evil-replace-state-tag  "REPLACE"
        evil-operator-state-tag "OPERATOR"
        evil-emacs-state-tag    "EMACS"
        evil-motion-state-tag   "MOTION"))
#+end_src

* Languages Configurations
** Org Mode Configurations
#+begin_src emacs-lisp
(use-package! org-superstar
  :hook (org-mode . org-superstar-mode)
  :config
  (setq org-superstar-headline-bullets-list '("⁖")
        org-superstar-item-bullet-alist '((?- . "•") (?+ . "•") (?* . "•"))
        org-hide-leading-stars t
        org-superstar-leading-bullet " "))

(after! org
  (setq org-ellipsis " ... "
        org-todo-keyword-faces
        '(("NOW" :foreground "#7c7c75" :weight normal :underline t)
          ("LATER" :foreground "#9f7efe" :weight normal :underline t)
          ("NEXT" :foreground "#0098dd" :weight normal :underline t)
          ("DONE" :foreground "#50a14f" :weight normal :underline t)
          ("CANCELLED" :foreground "#ff6480" :weight normal :underline t))
        org-priority-faces '((65 :foreground "#e45649")
                             (66 :foreground "#da8548")
                             (67 :foreground "#0098dd"))
        org-todo-keywords
        '((sequence "LATER(l)" "NOW(n)" "NEXT(N)" "|" "DONE(d)" "CANCELLED(c)")
          (sequence "[ ](t)" "[-](s)" "[?](w)" "|" "[X](x)")))

  ;; Better defaults
  (setq org-startup-indented t
        org-pretty-entities t
        org-hide-emphasis-markers t
        org-startup-with-inline-images t
        org-image-actual-width '(300)
        org-log-done 'time
        org-log-into-drawer t))

#+end_src
** Web Mode Configurations
#+begin_src emacs-lisp
(after! web-mode
  (setq-default indent-tabs-mode nil)  ; Use setq-default for buffer-local vars
  (setq web-mode-attr-indent-offset nil
        js-indent-level 2
        typescript-indent-level 2
        tab-width 2
        web-mode-code-indent-offset 2
        web-mode-css-indent-offset 2
        web-mode-markup-indent-offset 2
        web-mode-enable-auto-closing t
        web-mode-enable-auto-pairing t
        web-mode-auto-close-style 2
        web-mode-tag-auto-close-style 2))
#+end_src
** Rust Mode Configurations
#+begin_src emacs-lisp
(after! rustic
  (setq rustic-format-on-save t))
#+end_src
* Clients Configurations
** LSP
#+begin_src emacs-lisp
(after! eglot
  (setq eglot-code-action-indications nil
        eglot-sync-connect nil
        eglot-autoshutdown t
        eglot-send-changes-idle-time 0.5
        eglot-events-buffer-size 0))  ; Disable event logging for memory savings
#+end_src
** Company
#+begin_src emacs-lisp
(after! company
  ;; disable inline previews (use delete instead of delq for safety)
  (setq company-frontends (delete 'company-preview-if-just-one-frontend company-frontends))
  (setq company-idle-delay 0.2  ; Slight delay reduces CPU
        company-minimum-prefix-length 2  ; More reasonable
        company-tooltip-limit 10
        company-selection-wrap-around t
        company-show-quick-access t))  ; Renamed from company-show-numbers in newer versions
#+end_src
** Whitespace
#+begin_src emacs-lisp
(after! whitespace
  (setq whitespace-line-column 120  ; Standard column width
        whitespace-style
        '(face tabs spaces trailing lines space-before-tab newline indentation
          empty space-after-tab space-mark tab-mark newline-mark))

  ;; Customize whitespace markers
  (setq whitespace-display-mappings
        '(;; Space · (middle dot)
          (space-mark 32 [183] [46])           ; 32 SPACE → 183 MIDDLE DOT 「·」
          ;; Newline ¬ or ↵ or ¶
          (newline-mark 10 [172 10])           ; 10 LINE FEED → 172 NOT SIGN 「¬」
          ;; Tab » or → or ▸
          (tab-mark 9 [187 9] [92 9]))))       ; 9 TAB → 187 RIGHT DOUBLE ANGLE QUOTATION MARK 「»」

;; Enable whitespace mode only for smaller files to avoid performance issues
(defun my/selective-whitespace-mode ()
  "Enable whitespace-mode only for files smaller than 100KB."
  (when (< (buffer-size) (* 100 1024))
    (whitespace-mode 1)))

(defun my/line-length-indicators ()
  "Set up soft (100) and hard (120) line length indicators."
  (setq-local fill-column 100)
  (setq-local whitespace-line-column 120)
  (display-fill-column-indicator-mode 1))

(add-hook! 'prog-mode-hook #'my/line-length-indicators)
(add-hook! 'prog-mode-hook #'my/selective-whitespace-mode)
#+end_src
** Magit
#+begin_src emacs-lisp
;; Remove `--literal-pathspecs` argument which was causing `pre-commit` to fail
(after! magit
  (setq magit-git-global-arguments (remove "--literal-pathspecs" magit-git-global-arguments)))
#+end_src
** OpenCode
#+begin_src emacs-lisp
(use-package! opencode
  :defer t
  :commands (opencode opencode-connect opencode-new-session opencode-select-project)
  :config
  ;; Server configuration
  (setq opencode-host "127.0.0.1"
        opencode-port 8080
        opencode-auto-start-server t)  ; Auto-start server if not running

  ;; Authentication (if using password-protected server)
  ;; (setq opencode-server-username "your-username"
  ;;       opencode-server-password (lambda () (my/auth-get "opencode-password")))

  ;; Evil mode integration - ensure proper state in opencode buffers
  (after! evil
    (evil-set-initial-state 'opencode-mode 'insert)
    (evil-set-initial-state 'opencode-sessions-mode 'emacs))

  ;; Notifications on macOS
  (when (eq system-type 'darwin)
    (setq opencode-notification-function
          (lambda (title body)
            (ns-do-applescript
             (format "display notification %S with title %S"
                     body title)))))

  ;; Workaround for "This command must be called from a menu or a tool bar" error
  ;; when closing opencode sessions. This occurs when plz timer callbacks fire
  ;; during session cleanup.
  (advice-add 'plz--respond :around
              (lambda (orig-fun &rest args)
                (condition-case err
                    (apply orig-fun args)
                  (error
                   (unless (string-match-p "menu or a tool bar" (error-message-string err))
                     (signal (car err) (cdr err))))))))

;; Keybindings
(map! :leader
      (:prefix ("o c" . "opencode")
       :desc "Open OpenCode" "c" #'opencode
       :desc "Connect to server" "C" #'opencode-connect
       :desc "New session" "n" #'opencode-new-session
       :desc "Select project" "p" #'opencode-select-project
       :desc "Select open session" "s" #'opencode-select-open-session
       :desc "New worktree" "w" #'opencode-new-worktree
       :desc "Visit last idle" "i" #'opencode-visit-last-idle))
#+end_src

** pi-coding-agent
#+begin_src emacs-lisp
(use-package! pi-coding-agent
  :defer t
  :commands (pi-coding-agent)
  :init (defalias 'pi 'pi-coding-agent)
  :config
  ;; Streaming performance
  (setq pi-coding-agent-fontify-idle-delay 0.15       ; Faster highlighting during streaming (default 0.2)
        pi-coding-agent-markdown-search-limit 20000   ; Limit backward search for code blocks in long sessions
        pi-coding-agent-visit-file-other-window t)

  ;; Evil mode integration
  (after! evil
    (evil-set-initial-state 'pi-coding-agent-input-mode 'insert)
    (evil-set-initial-state 'pi-coding-agent-chat-mode 'emacs)))

;; Keybindings - only entry points; use C-c C-p inside pi buffers for the full transient menu
(map! :leader
      (:prefix ("o p" . "pi-coding-agent")
       :desc "Start pi-coding-agent" "p" #'pi-coding-agent
       :desc "Open menu" "m" #'pi-coding-agent-menu))
#+end_src

* Performance Optimizations
** Native Compilation
#+begin_src emacs-lisp
;; Native compilation settings
(when (featurep 'native-compile)
  (setq native-comp-async-report-warnings-errors nil
        native-comp-jit-compilation t))  ; Emacs 29+ (replaces deprecated native-comp-deferred-compilation)
#+end_src

** Which-key Performance
#+begin_src emacs-lisp
;; Faster which-key popup
(after! which-key
  (setq which-key-idle-delay 0.5))  ; Default is 1.0
#+end_src

** Projectile
#+begin_src emacs-lisp
;; Use faster indexing method
(after! projectile
  (setq projectile-indexing-method 'hybrid  ; faster than alien for large projects
        projectile-enable-caching t))
#+end_src
